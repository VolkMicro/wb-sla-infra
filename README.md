# Контроль SLA на портале техподдержки Wiren Board

## Цель
Контроль SLA и предотвращение нарушений на портале техподдержки Wiren Board. Автоматизация уведомлений и отчётности.

## Архитектура
- **n8n** – агрегация данных, проверка SLA, уведомления.
- **InfluxDB** – хранение SLA‑логов.
- **Grafana** – визуализация статистики и отчётов.
- Секреты (Discourse API, Telegram Bot, InfluxDB) хранятся в файле `.env` и в n8n Credentials; `.env` не коммитится, в Git попадает только логика workflow.

## SLA‑правила
- Первый ответ и время реакции – не более 2 часов в рабочее время (пн–пт, 9:00–18:00 МСК).
- Оповещения:
  - за 1 час до дедлайна;
  - за 30 минут до дедлайна;
  - «Ахтунг» при нарушении SLA (после 2 часов).
- Проверка SLA каждые 30 минут.
- Если тикет уже предупреждён, повторно предупреждение не отправляется (только нарушение).
- Утренний отчёт (08:00 МСК): список всех тикетов без ответа, где SLA нарушен.
- Закрытие по неактивности:
  - если наш последний ответ и клиент молчит 14 дней – напоминание инженеру;
  - если клиент молчит 3 дня – напоминание инженеру «пнуть клиента».

## Источник данных
Data Explorer / Discourse API. SQL‑запрос возвращает:
- `ticket_id`
- `status` (open / in progress / closed)
- `assignee`
- `author`
- `created_at`
- `last_post_at`

## Telegram‑уведомления
- Формат: короткий текст + ссылка на тикет.
- Получатели: инженер и/или дежурный.
- Каналы доставки:
  - ⚠ предупреждения и ❌ нарушения – в общий чат;
  - персональные уведомления в ЛС инженерам (если есть username).

## Grafana и отчётность
Метрики в InfluxDB:
- `ticket_id`
- `assignee`
- `event_type` (warn / violation)
- `timestamp`
- `overdue_minutes`

Визуализация:
- Статистика по инженерам (кто сколько нарушил SLA).
- Ежедневные итоги (% SLA выполненных, среднее время ответа).
- История нарушений.
- Ежедневный отчёт по команде.

## Логика SLA в n8n
- **Cron** (каждые 30 минут).
- **HTTP Request** → Data Explorer API (SQL‑запрос).
- **Function Node** → расчёт SLA с учётом рабочих часов.
- **Switch Node** → ветки предупреждение (1 час), предупреждение (30 мин), нарушение.
- **Telegram Node** → бот шлёт уведомления.
- **InfluxDB Node** → логирование события.
- Отдельный **Cron** (08:00 МСК) → отчёт о всех нарушенных SLA.

## Git и IaC
В Git хранятся:
- `docker-compose.yml`;
- конфиги Grafana, InfluxDB, n8n workflows (без секретов).
- файл `.env.example` (образец). Настоящий `.env` с секретами хранится локально и не коммитится.

Все изменения проходят через коммиты и redeploy. Развёртывание контейнеров из Git на сервере.

## Локальная проверка SLA
Для тестирования логики SLA в репозитории есть простой Python‑модуль `sla`,
который рассчитывает статус тикета с учётом рабочих часов. Запустить проверки
можно командой:

```bash
python3 -m pytest -q
```

Тесты проверяют сценарии предупреждений и нарушения SLA, включая учёт
выходных и времени вне рабочего дня.

